# 아키텍처

이 문서는 ZAI 인증 플러그인의 아키텍처를 설명합니다.

## 개요

ZAI 인증 플러그인은 ZAI API를 위한 OpenCode 인증 플러그인입니다. 여러 API 키를 효율적으로 사용하기 위해 라운드 로빈(round-robin) 전략을 이용한 동적 API 키 로테이션을 지원합니다.

- **Provider ID**: `"zai-coding-plan"` (이 ID는 내장 프로바이더를 덮어씁니다).

## 핵심 구성 요소

1.  **설정 로더 (Config Loader)** (`src/plugin/config/loader.ts`): 기본값, JSON 설정 파일, 환경 변수로부터 설정을 병합하는 역할을 합니다.
2.  **설정 스키마 (Config Schema)** (`src/plugin/config/schema.ts`): 설정 옵션에 대한 유효성 검사 스키마를 정의합니다.
3.  **메인 플러그인 (Main Plugin)** (`index.ts`): 설정 및 로테이션 로직을 통합하여 인증 요청을 처리하는 진입점입니다.

## 동작 흐름

1.  **초기화**: 플러그인이 초기화되면서 설정 파일과 환경 변수로부터 설정을 로드합니다.
2.  **동적 키 로드**: `ZAI_API_KEY_0~N` 패턴과 일치하는 환경 변수에서 API 키를 동적으로 로드합니다.
3.  **라운드 로빈 로테이션**: 각 요청에 대해 플러그인은 라운드 로빈 방식으로 다음 가용 키를 선택합니다.
4.  **에러 처리**: 요청이 429(Rate Limit), 401(Unauthorized) 또는 5xx(Server Error)로 실패하면 현재 키를 제한됨 또는 유효하지 않음으로 표시합니다.
5.  **재시도 로직**: 플러그인은 다음 가용 키를 사용하여 요청을 자동으로 재시도합니다. 최대 시도 횟수는 로드된 키의 개수와 같습니다.
6.  **쿨다운 (Cooldown)**: 키는 쿨다운 기간 동안 사용 불가능한 상태로 유지됩니다. 쿨다운은 `Retry-After` 헤더에 별도 명시가 없는 한 기본적으로 60초입니다. 쿨다운이 만료되면 키는 다시 가용 상태가 됩니다.
